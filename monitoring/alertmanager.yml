# ============================================
# 手语AI平台 Alertmanager 配置文件
# ============================================
# 功能：
# - 告警路由配置
# - 告警抑制规则
# - 告警静默规则
# - 通知通道配置（邮件、Webhook、企业微信等）
# ============================================

# 全局配置
global:
  # SMTP 邮件服务器配置
  smtp_smarthost: '${ALERTMANAGER_SMTP_HOST:-smtp.gmail.com}:${ALERTMANAGER_SMTP_PORT:-587}'
  smtp_from: '${ALERTMANAGER_SMTP_FROM:-noreply@signai.com}'
  smtp_auth_username: '${ALERTMANAGER_SMTP_USER:-}'
  smtp_auth_password: '${ALERTMANAGER_SMTP_PASSWORD:-}'
  smtp_require_tls: true
  
  # 邮件通知时间间隔
  resolve_timeout: 5m

# 告警路由
route:
  # 默认接收器
  receiver: 'default-receiver'
  
  # 是否继续处理匹配的子路由
  continue: false
  
  # 分组等待时间
  group_wait: 30s
  
  # 分组间隔
  group_interval: 5m
  
  # 重复告警通知间隔
  repeat_interval: 12h
  
  # 分组标签
  group_by: ['alertname', 'cluster', 'service']
  
  # 子路由规则
  routes:
    # ============================================
    # 严重告警路由
    # ============================================
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 5m
      
    # ============================================
    # 警告告警路由
    # ============================================
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 30s
      repeat_interval: 30m
      
    # ============================================
    # 数据库告警路由
    # ============================================
    - match:
        service: database
      receiver: 'database-receiver'
      group_by: ['alertname', 'database']
      
    # ============================================
    # API 服务告警路由
    # ============================================
    - match:
        service: api
      receiver: 'api-receiver'
      group_by: ['alertname', 'endpoint']
      
    # ============================================
    # AI 模型告警路由
    # ============================================
    - match:
        service: ai-model
      receiver: 'ai-model-receiver'
      group_by: ['alertname', 'model_name']

# ============================================
# 接收器配置
# ============================================

# ============================================
# 默认接收器
# ============================================
receivers:
  - name: 'default-receiver'
    email_configs:
      - to: '${ALERTMANAGER_NOTIFICATION_EMAIL:-admin@example.com}'
        headers:
          Subject: '[手语AI平台] {{ .GroupLabels.alertname }}'
          From: 'AlertManager <noreply@signai.com>'
        html: '{{ template "email.default.html" . }}'
    
    # 企业微信通知（可选）
    # wecom_configs:
    #   - corp_id: '${WEWORK_CORP_ID}'
    #     api_secret: '${WEWORK_API_SECRET}'
    #     to_party: '${WEWORK_TO_PARTY}'
    #     message: '{{ template "wecom.default.message" . }}'
    
    # 钉钉通知（可选）
    # dingtalk_configs:
    #   - url: '${DINGTALK_WEBHOOK_URL}'
    #     message: '{{ template "dingtalk.default.message" . }}'
  # ============================================
  # 严重告警接收器
  # ============================================
  - name: 'critical-receiver'
    email_configs:
      - to: '${ALERTMANAGER_CRITICAL_EMAIL:-oncall@example.com}'
        headers:
          Subject: '[严重] [手语AI平台] {{ .GroupLabels.alertname }}'
          From: 'AlertManager <urgent@signai.com>'
        html: '{{ template "email.critical.html" . }}'
    
    # Webhook 通知（用于自动化处理）
    webhook_configs:
      - url: 'http://webhook-receiver:5000/alerts'
        send_resolved: true

  # ============================================
  # 警告告警接收器
  # ============================================
  - name: 'warning-receiver'
    email_configs:
      - to: '${ALERTMANAGER_NOTIFICATION_EMAIL:-admin@example.com}'
        headers:
          Subject: '[警告] [手语AI平台] {{ .GroupLabels.alertname }}'
          From: 'AlertManager <warning@signai.com>'
        html: '{{ template "email.warning.html" . }}'

  # ============================================
  # 数据库告警接收器
  # ============================================
  - name: 'database-receiver'
    email_configs:
      - to: '${DBA_EMAIL:-dba@example.com}'
        headers:
          Subject: '[数据库] [手语AI平台] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.database.html" . }}'

  # ============================================
  # API 服务告警接收器
  # ============================================
  - name: 'api-receiver'
    email_configs:
      - to: '${DEVOPS_EMAIL:-devops@example.com}'
        headers:
          Subject: '[API] [手语AI平台] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.api.html" . }}'

  # ============================================
  # AI 模型告警接收器
  # ============================================
  - name: 'ai-model-receiver'
    email_configs:
      - to: '${ML_EMAIL:-ml-team@example.com}'
        headers:
          Subject: '[AI模型] [手语AI平台] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.ai-model.html" . }}'

# ============================================
# 告警抑制规则
# ============================================
inhibit_rules:
  # 如果服务已宕机，则抑制该服务的高错误率告警
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighErrorRate'
    equal: ['instance']
  
  # 如果 CPU 使用率过高，则抑制内存使用率告警（可能相关）
  - source_match:
      alertname: 'HighCPUUsage'
      severity: 'critical'
    target_match:
      alertname: 'HighMemoryUsage'
      severity: 'warning'
    equal: ['instance']
  
  # 如果数据库连接已耗尽，则抑制数据库查询慢告警
  - source_match:
      alertname: 'DatabaseConnectionPoolExhausted'
    target_match:
      alertname: 'SlowDatabaseQuery'
    equal: ['database']
  
  # 如果服务器已宕机，则抑制所有该服务器的告警
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']

# ============================================
# 告警模板
# ============================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ============================================
# 告警模板示例（需要单独创建模板文件）
# ============================================

# 邮件模板示例（/etc/alertmanager/templates/email.default.tmpl）
# {{ define "email.default.html" }}
# <!DOCTYPE html>
# <html>
# <head>
#     <meta charset="utf-8">
#     <style>
#         body { font-family: Arial, sans-serif; }
#         .alert { padding: 20px; border-left: 4px solid #f39c12; background: #f9f9f9; }
#         .alert.critical { border-left-color: #e74c3c; }
#         .alert.warning { border-left-color: #f39c12; }
#         table { width: 100%; border-collapse: collapse; margin-top: 20px; }
#         th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
#         th { background: #f5f5f5; }
#     </style>
# </head>
# <body>
#     <div class="alert {{ .GroupLabels.severity }}">
#         <h2>{{ .GroupLabels.alertname }}</h2>
#         <p><strong>集群:</strong> {{ .GroupLabels.cluster }}</p>
#         <p><strong>服务:</strong> {{ .GroupLabels.service }}</p>
#         <p><strong>实例:</strong> {{ .GroupLabels.instance }}</p>
#         <p><strong>时间:</strong> {{ .Alerts.Firing | len }} 个告警触发</p>
#         {{ if .Alerts.Resolved }}
#         <p><strong>已解决:</strong> {{ .Alerts.Resolved | len }} 个告警已解决</p>
#         {{ end }}
#     </div>
#     
#     <table>
#         <thead>
#             <tr>
#                 <th>告警</th>
#                 <th>级别</th>
#                 <th>描述</th>
#                 <th>时间</th>
#             </tr>
#         </thead>
#         <tbody>
#         {{ range .Alerts }}
#         <tr>
#             <td>{{ .Labels.alertname }}</td>
#             <td>{{ .Labels.severity }}</td>
#             <td>{{ .Annotations.description }}</td>
#             <td>{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
#         </tr>
#         {{ end }}
#         </tbody>
#     </table>
# </body>
# </html>
# {{ end }}

# 企业微信模板示例
# {{ define "wecom.default.message" }}
# {
#   "msgtype": "text",
#   "text": {
#     "content": "【手语AI平台告警】\n告警名称: {{ .GroupLabels.alertname }}\n告警级别: {{ .GroupLabels.severity }}\n集群: {{ .GroupLabels.cluster }}\n服务: {{ .GroupLabels.service }}\n实例: {{ .GroupLabels.instance }}\n描述: {{ .Alerts.Firing | len }} 个告警触发\n\n{{ range .Alerts }}- {{ .Annotations.description }}\n{{ end }}"
#   }
# }
# {{ end }}

# 钉钉模板示例
# {{ define "dingtalk.default.message" }}
# {
#   "msgtype": "markdown",
#   "markdown": {
#     "title": "【手语AI平台告警】{{ .GroupLabels.alertname }}",
#     "text": "### 告警通知\n\n**告警名称**: {{ .GroupLabels.alertname }}\n\n**告警级别**: <font color=\"warning\">{{ .GroupLabels.severity }}</font>\n\n**集群**: {{ .GroupLabels.cluster }}\n\n**服务**: {{ .GroupLabels.service }}\n\n**实例**: {{ .GroupLabels.instance }}\n\n**描述**: {{ .Alerts.Firing | len }} 个告警触发\n\n{{ range .Alerts }}- {{ .Annotations.description }}\n{{ end }}"
#   }
# }
# {{ end }}

# ============================================
# 告警时间窗口配置
# ============================================

# time_intervals:
#   - name: 'business_hours'
#     time_intervals:
#       - times:
#           - start_time: '09:00'
#             end_time: '18:00'
#         weekdays: ['monday:friday']
#   
#   - name: 'off_hours'
#     time_intervals:
#       - times:
#           - start_time: '00:00'
#             end_time: '24:00'
#         weekdays: ['saturday', 'sunday']
#       - times:
#           - start_time: '18:00'
#             end_time: '09:00'
#         weekdays: ['monday:friday']
#
#   - name: 'holidays'
#     time_intervals:
#       - months: ['january']
#         days_of_month: ['1st']
#       - months: ['october']
#         days_of_month: ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th']

# ============================================
# 静默规则示例
# ============================================

# 静默规则通过 API 动态管理
# 示例：创建静默规则
# curl -X POST http://localhost:9093/api/v2/silences -d '{
#   "matchers": [
#     {
#       "name": "severity",
#       "value": "warning",
#       "isRegex": false
#     },
#     {
#       "name": "instance",
#       "value": "test.*",
#       "isRegex": true
#     }
#   ],
#   "startsAt": "2023-01-01T00:00:00Z",
#   "endsAt": "2023-01-02T00:00:00Z",
#   "createdBy": "admin",
#   "comment": "测试环境维护"
# }'

# ============================================
# 告警路由高级配置
# ============================================

# 根据时间路由（需要配合 time_intervals）
# routes:
#   - match:
#       severity: warning
#     receiver: 'daily-email-receiver'
#     active_time_intervals:
#       - 'business_hours'
#   - match:
#       severity: warning
#     receiver: 'urgent-email-receiver'
#     active_time_intervals:
#       - 'off_hours'
#
#   - match:
#       severity: critical
#     receiver: 'daily-email-receiver'
#     match_re:
#       service: '(backend|database)'
#     active_time_intervals:
#       - 'business_hours' - 'holidays'